@using Microsoft.AspNetCore.Identity
@using OnlineCardShop.Data
@using OnlineCardShop.Data.Models
@using OnlineCardShop.Infrastructure
@using OnlineCardShop.Services.Dealers

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@inject IDealerService Dealers
@inject OnlineCardShopDbContext data;

<ul class="navbar-nav">
@if (SignInManager.IsSignedIn(User))
{
    var userId = User.GetId();
    var userIsDealer = Dealers.IsDealer(userId);
    var userIsAdmin = User.IsAdmin();

    var currentUserProfileImagePath = new { path = string.Empty };
    string imagePath;

    if(!userIsAdmin){
        currentUserProfileImagePath = this.data
        .Users
        .Where(u => u.Id == userId)
        .Select(user => new 
        { 
            path = user.ProfileImage.Path
        })
        .FirstOrDefault();

        imagePath = currentUserProfileImagePath.path.Replace("res", string.Empty);
    }else{
        imagePath = "ProfileImages/admin.png";
    }

    if(!userIsDealer && !userIsAdmin){
        <li class="nav-item">
            <a  class="nav-link text-dark" asp-area="" asp-controller="Dealers" asp-action="Create">Become a Dealer</a>
        </li>
    }else if(!userIsAdmin && userIsDealer){
        <li class="nav-item">
          <a class="nav-link text-dark" asp-area="" asp-controller="Cards" asp-action="Mine">My Cards</a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-dark" asp-area="" asp-controller="Cards" asp-action="Add">Add Card</a>
        </li>
    }else if (userIsAdmin)
    {
        <li class="nav-item">
            <a  class="nav-link text-dark" asp-area="Admin" asp-controller="Cards" asp-action="Index">Administration</a>
        </li>
    }
        <li class="nav-item">
          <a class="nav-link text-dark" asp-area="" asp-controller="User" asp-action="Messages">Messages</a>
        </li>
        <li class="nav-item">
            <a  class="nav-link text-dark" asp-area="Identity" asp-page="/Account/Manage/Index" title="Manage">Account</a>
        </li>
        <li class="nav-item">
            <form  class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                <button  type="submit" class="nav-link btn btn-link text-dark">Logout</button>
            </form>
        </li>
        <li>
            <img class="rounded-circle z-depth-2" style="height:70px; width:70px;" src="/@imagePath" data-holder-rendered="true">
        </li>
    }
else
{
    <li class="nav-item">
        <a class="nav-link text-dark" asp-area="Identity" asp-page="/Account/Register">Register</a>
    </li>
    <li class="nav-item">
        <a class="nav-link text-dark" asp-area="Identity" asp-page="/Account/Login">Login</a>
    </li>
}
</ul>
